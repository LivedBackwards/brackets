// 

#include <v8.h>
#include <uv.h>
#include <node.h>

#define MAXPATH 1024
#define READ_DIRECTORY_CHANGES_BUFSIZE  8192

using namespace v8;

static Persistent<FunctionTemplate> constructor_template;
static Persistent<String> emit_sym;
static Persistent<String> change_sym;

class CAsyncDirWatchInfo
{
public:
    CAsyncDirWatchInfo() {}
    ~CAsyncDirWatchInfo() {}
};

class NodeFSEvents : public node::ObjectWrap
{
public:
    NodeFSEvents(const char *szPath);
    ~NodeFSEvents();

    // JS wrapper methods
    static void Initialize(v8::Handle<v8::Object> target);
    static v8::Handle<v8::Value> Shutdown(const v8::Arguments& args);
    static v8::Handle<v8::Value> New(const v8::Arguments& args);

    // file watching methods
    void Shutdown();
    static DWORD WINAPI Run(LPVOID lpData);
    static void Callback(uv_async_t *handle, int status);

    char m_szPathName[MAXPATH + 1];
    uv_async_t m_uvaWatcher;
    HANDLE m_hAsyncDir;
    HANDLE m_hIoCPort;
    CAsyncDirWatchInfo *m_pWatchInfo;
    OVERLAPPED m_Overlapped;
    HANDLE m_hThread;
    PFILE_NOTIFY_INFORMATION m_lpBuffer;
};
